<!-- ✅ CSS -->
<style>
.custom-auth-container {
    max-width: 480px;
    width: 90%;
    margin: 0 auto;
    padding: 25px;
    font-family: Arial, sans-serif;
    background: #ffffff;
    box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.1);
    border-radius: 8px;
}
.auth-wrapper {
    text-align: center;
}
.auth-form {
    display: flex;
    flex-direction: column;
    text-align: left;
}
.auth-form h2 {
    font-size: 24px;
    margin-bottom: 20px;
    text-align: center;
    font-weight: bold;
}
.auth-form label {
    font-weight: bold;
    margin-top: 15px;
    font-size: 15px;
}
.auth-form input {
    width: calc(100% - 20px);
    padding: 12px;
    margin-top: 6px;
    margin-bottom: 15px;
    border: 1px solid #ccc;
    border-radius: 5px;
    font-size: 15px;
    box-shadow: inset 0px 2px 4px rgba(0, 0, 0, 0.05);
}
.auth-form button {
    margin-top: 20px;
    padding: 14px;
    background: #007bff;
    color: white;
    border: none;
    border-radius: 6px;
    font-size: 17px;
    cursor: pointer;
    transition: background 0.3s ease, transform 0.2s ease;
    width: 100%;
    font-weight: bold;
}
.auth-form button:hover {
    background: #0056b3;
    transform: scale(1.02);
}
.status-message {
    text-align: center;
    margin-top: 15px;
    font-size: 14px;
    color: red;
    width: 100%;
    display: block;
}
@media (max-width: 600px) {
    .custom-auth-container {
        width: 95%;
        padding: 20px;
    }
    .auth-form input {
        width: 100%;
    }
}
.btn-spinner {
    display: inline-block;
    width: 18px;
    height: 18px;
    margin-right: 8px;
    vertical-align: middle;
    border: 2px solid rgba(255, 255, 255, 0.4);
    border-top-color: #ffffff;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}
@keyframes spin {
    to {
        transform: rotate(360deg);
    }
}
</style>

<!-- ✅ HTML Form -->
<div class="custom-auth-container">
  <div class="auth-wrapper">
    <form id="reset-form" class="auth-form" onsubmit="return resetPassword(this);">
      <h2>Reset Your Password</h2>
      <label for="reset-password">New Password:</label>
      <input type="password" id="reset-password" name="password" placeholder="Enter new password" minlength="8" maxlength="100" required>

      <label for="reset-confirm-password">Confirm Password:</label>
      <input type="password" id="reset-confirm-password" name="confirm_password" placeholder="Confirm new password" minlength="8" maxlength="100" required>

      <button type="submit" id="reset-btn">Reset Password</button>

      <p id="reset-status" class="status-message" style="text-align:center; margin-top: 1rem;"></p>
    </form>

    <p id="status" class="status-message" style="text-align:center">{{custom_block_verify}}</p>
  </div>
</div>

<!-- ✅ JavaScript -->
<script>
async function resetPassword(form) {
  event.preventDefault();

  const btn = document.getElementById('reset-btn');
  const originalText = btn.innerHTML;
  const statusEl = document.getElementById('reset-status');

  btn.innerHTML = '<span class="btn-spinner"></span> Resetting...';
  btn.disabled = true;
  statusEl.textContent = "";

  try {
    const token = "{{custom_block_token_reset}}";
    const tokenId = "{{custom_block_token_id}}";
    const password = form.querySelector('#reset-password').value;
    const confirmPassword = form.querySelector('#reset-confirm-password').value;

    if (/[\r\t\n\s]/.test(password) || password !== password.trim()) {
      throw new Error('Password contains leading or trailing whitespace.');
    }

    if (confirmPassword !== password || /[\r\t\n\s]/.test(confirmPassword)) {
      throw new Error('Passwords do not match or contain whitespace.');
    }

    const response = await fetch('/growthworld-premium-tools/reset-password', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ password, confirmPassword, token, tokenId })
    });

    const data = await response.json();

    if (data.status === 'success') {
      showPopup(data.message, 'info');
      form.reset();
      form.outerHTML = '<div style="text-align:center"><a style="text-decoration:none" href="/growthworld-premium-tools/login">Back to Login!</a></div>';
    } else {
      showPopup(data.message || 'Something went wrong. Please try again.', 'error');
    }
  } catch (error) {
    console.error(error);
    showPopup('An error occurred: ' + error.message, 'error');
  } finally {
    btn.innerHTML = originalText;
    btn.disabled = false;
  }

  return false;
}

function addPopupStyles() {
  if (!document.querySelector('#popup-styles')) {
    const style = document.createElement('style');
    style.id = 'popup-styles';
    style.textContent = `
      .popup-container {
        position: fixed;
        top: 10px;
        left: 10px;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .popup {
        min-width: 200px;
        padding: 10px 15px;
        border-radius: 5px;
        color: white;
        font-family: Arial, sans-serif;
        font-size: 14px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        animation: fadeInOut 5s ease-in-out forwards;
      }
      .popup.info {
        background-color: green;
      }
      .popup.error {
        background-color: red;
      }
      @keyframes fadeInOut {
        0% { opacity: 0; transform: translateY(-10px); }
        10%, 90% { opacity: 1; transform: translateY(0); }
        100% { opacity: 0; transform: translateY(-10px); }
      }
    `;
    document.head.appendChild(style);
  }
}

function showPopup(message, type) {
  addPopupStyles();

  if (!document.querySelector('.popup-container')) {
    const container = document.createElement('div');
    container.className = 'popup-container';
    document.body.appendChild(container);
  }

  const popup = document.createElement('div');
  popup.className = `popup ${type}`;
  popup.textContent = message;

  document.querySelector('.popup-container').appendChild(popup);
  const status = document.getElementById('status');
  if (status) {
    status.innerHTML = message;
    status.style.color = type === 'info' ? 'blue' : 'red';
  }

  setTimeout(() => popup.remove(), 5000);
}
</script>
